persistence:
  enabled: true
  storageClassName: nfs-ssd-1
  annotations:
    folder: monitoring/grafana

initChownData:
  securityContext:
    runAsUser: null
    runAsNonRoot: null

admin:
  existingSecret: grafana-admin
  userKey: user
  passwordKey: password

envFromSecrets:
  - name: grafana-discord
    prefix: DISCORD_

datasources:
  datasources.yaml:
    apiVersion: 1
    prune: true
    datasources:
      - name: Mimir
        type: prometheus
        uid: mimir
        url: http://mimir-gateway.mimir.svc.cluster.local/prometheus
        access: proxy
        isDefault: true
        jsonData:
          manageAlerts: false
          prometheusType: Mimir
          httpHeaderName1: X-Scope-OrgID
        secureJsonData:
          httpHeaderValue1: k8s-nas
      - name: Loki
        type: loki
        uid: loki
        url: http://loki-gateway.loki.svc.cluster.local
        access: proxy
        jsonData:
          timeout: 60
          maxLines: 1000
          httpHeaderName1: X-Scope-OrgID
        secureJsonData:
          httpHeaderValue1: k8s-nas

alerting:
  policies.yaml:
    apiVersion: 1
    policies:
      - orgId: 1
        receiver: Discord
        group_by:
          - grafana_folder
          - alertname
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
  contactpoints.yaml:
    apiVersion: 1
    contactPoints:
      - orgId: 1
        name: Discord
        receivers:
          - uid: discord
            type: discord
            settings:
              url: $DISCORD_WEBHOOK_URL
              title: |
                {{`{{ template "discord.title" . }}`}}
              message: |
                {{`{{ template "discord.message" . }}`}}
  templates.yaml:
    apiVersion: 1
    templates:
      - orgId: 1
        name: Discord Template
        template: |
          {{`{{ define "__discord_subject" }}{{ if eq .Status "firing" }}[FIRING:{{ .Alerts.Firing | len }}]{{ else }}[RESOLVED:{{ .Alerts.Resolved | len }}]{{ end }} {{ .GroupLabels.SortedPairs.Values | join " " }}{{ end }}

          {{ define "__discord_text_alert_list" }}{{range .}}
          Value: {{template "__discord_text_values_list" .}}

          Started: <t:{{ .StartsAt.Unix }}:R>{{if eq .Status "resolved" }}
          Ended: <t:{{ .EndsAt.Unix }}:R>
          {{end}}
          Labels:
          {{range .Labels.SortedPairs}}- {{.Name}} = {{.Value}}
          {{end}}
          Annotations:
          {{range .Annotations.SortedPairs}}- {{.Name}} = {{.Value}}
          {{end}}
          {{if gt (len .GeneratorURL) 0}}[üîç View in Grafana]({{.GeneratorURL}}){{end}}
          {{if gt (len .SilenceURL) 0}}[üîá Silence Alert]({{.SilenceURL}}){{end}}
          {{if gt (len .DashboardURL) 0}}[üìà View Dashboard]({{.DashboardURL}}){{end}}
          {{if gt (len .PanelURL) 0}}[üìâ View Panel]({{.PanelURL}}){{end}}

          {{end}}
          {{ end }}

          {{ define "__discord_text_values_list" }}{{if len .Values}}{{$first := true}}{{range $refID, $value := .Values}}{{if $first}}{{$first = false}}{{else}}, {{end}}{{$refID}}={{$value}}{{end}}{{else}}[no value]{{end}}{{ end }}

          {{ define "discord.message" }}
          ## {{template "__discord_subject" .}}{{if gt (len .Alerts.Firing) 0}}
          {{template "__discord_text_alert_list" .Alerts.Firing}}
          {{end}}{{if gt (len .Alerts.Resolved) 0}}
          {{template "__discord_text_alert_list" .Alerts.Resolved}}
          {{end}}
          {{ end }}

          {{ define "discord.title" }}{{template "__discord_subject" .}}{{ end }}`}}

grafana.ini:
  date_formats:
    default_timezone: browser
  auth.generic_oauth:
    enabled: true
    name: Authentik
    client_id: $__file{/etc/secrets/generic-oauth/client_id}
    client_secret: $__file{/etc/secrets/generic-oauth/client_secret}
    scopes: openid profile email offline_access
    role_attribute_path: contains(groups, 'Grafana Admins') && 'Admin' || contains(groups, 'Grafana Editors') && 'Editor' || 'Viewer'
    use_refresh_token: true
  recording_rules:
    default_datasource_uid: mimir

sidecar:
  alerts:
    enabled: true
    searchNamespace: ALL
  dashboards:
    enabled: true
    searchNamespace: ALL
    folderAnnotation: grafana_folder
    provider:
      disableDelete: true
      foldersFromFilesStructure: true

extraSecretMounts:
  - name: generic-oauth
    secretName: grafana-generic-oauth
    mountPath: /etc/secrets/generic-oauth
    defaultMode: 0440
    readOnly: true
